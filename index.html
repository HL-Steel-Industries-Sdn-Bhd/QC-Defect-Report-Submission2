<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QC Defect Submission</title>
<style>
  body { font-family: sans-serif; padding: 10px; max-width: 600px; margin: auto; }
  .row { display: flex; margin-bottom: 10px; flex-wrap: wrap; }
  .row label { flex: 1; min-width: 120px; }
  .row input, .row textarea { flex: 2; min-width: 150px; padding: 5px; }
  #photoPreview { margin-top: 10px; width: 100%; max-height: 300px; object-fit: contain; border: 1px solid #ccc; }
  button { padding: 10px 15px; margin-top: 10px; }
</style>
</head>
<body>

<h2>QC Defect Submission</h2>

<div class="row">
  <label for="salesOrder">Sales Order No.</label>
  <input type="text" id="salesOrder">
</div>
<div class="row">
  <label for="itemNo">Item No.</label>
  <input type="text" id="itemNo">
</div>
<div class="row">
  <label for="customerName">Customer Name</label>
  <input type="text" id="customerName">
</div>
<div class="row">
  <label for="itemName">Item Name</label>
  <input type="text" id="itemName">
</div>
<div class="row">
  <label for="defectDesc">Defect Description</label>
  <textarea id="defectDesc" rows="3"></textarea>
</div>
<div class="row">
  <label for="defectCount">Defective Item Count</label>
  <input type="number" id="defectCount">
</div>

<button id="takePhotoBtn">Take Photo</button>
<img id="photoPreview" src="">
<button id="submitBtn">Submit</button>

<script>
let imageBlob = null;

// 压缩函数
async function compressImage(file, maxWidth = 1024, quality = 0.7) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const scale = Math.min(1, maxWidth / img.width);
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      canvas.toBlob((blob) => resolve(blob), 'image/jpeg', quality);
    };
    img.src = URL.createObjectURL(file);
  });
}

// Blob 转 Base64
function blobToBase64(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

// 拍照按钮
document.getElementById('takePhotoBtn').addEventListener('click', async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } } // 后置摄像头
    });
    const track = stream.getVideoTracks()[0];
    const imageCapture = new ImageCapture(track);
    const photo = await imageCapture.takePhoto();
    const compressed = await compressImage(photo);
    imageBlob = compressed;
    document.getElementById('photoPreview').src = URL.createObjectURL(compressed);
    track.stop();
  } catch (err) {
    alert("Camera error or permission denied: " + err.message);
  }
});

// 提交按钮
document.getElementById('submitBtn').addEventListener('click', async () => {
  if (!imageBlob) return alert("Take a photo first");

  const data = {
    salesOrder: document.getElementById('salesOrder').value.trim(),
    itemNo: document.getElementById('itemNo').value.trim(),
    customerName: document.getElementById('customerName').value.trim(),
    itemName: document.getElementById('itemName').value.trim(),
    defectDesc: document.getElementById('defectDesc').value.trim(),
    defectCount: document.getElementById('defectCount').value.trim()
  };

  // 转 Base64
  data.imageBase64 = await blobToBase64(imageBlob);

  try {
    const resp = await fetch("https://script.google.com/macros/s/AKfycbx8hU9lV7Lp3WwMxAD3chNg8r3gep_lITVvSho8z3GIw4EQUt6lyAWdbh5sgVLSsPqW/exec", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    const text = await resp.text();
    alert(text);
  } catch (err) {
    alert("Submission failed: " + err);
  }
});
</script>

</body>
</html>
